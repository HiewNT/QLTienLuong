@model QLTienLuong.Models.HuongPhuCap

@{
    ViewData["Title"] = "Thêm mới Hưởng Phụ cấp";
}

<div class="fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="mb-1">
                <i class="fas fa-plus-circle me-2"></i>Thêm mới Hưởng Phụ cấp
            </h5>
            <small class="text-muted">Thêm hướng phụ cấp cho học viên</small>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Quay lại
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="card">
        <div class="card-body">
            <form asp-action="Create" method="post">
                <div asp-validation-summary="All" class="text-danger"></div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="MaHocVien" class="form-label">Học viên <span class="text-danger">*</span></label>
                            <select asp-for="MaHocVien" class="form-select" asp-items="ViewBag.MaHocVien">
                                <option value="">-- Chọn học viên --</option>
                            </select>
                            <span asp-validation-for="MaHocVien" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Tháng/Năm <span class="text-danger">*</span></label>
                            <input type="month" name="ThangNam" class="form-control" required />
                            <span asp-validation-for="ThangNam" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Danh mục phụ cấp được nhận -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="mb-2"><i class="fas fa-list me-2"></i>Danh mục phụ cấp được nhận</h6>
                        <div id="danhMucPhuCapList" class="alert alert-light border">
                            <div class="text-muted text-center">Chọn học viên để xem danh mục phụ cấp</div>
                        </div>
                    </div>
                </div>

                <!-- Các khoản trừ -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="mb-2"><i class="fas fa-minus-circle me-2"></i>Các khoản trừ</h6>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="DoanPhi" class="form-label">Đoàn phí</label>
                            <input asp-for="DoanPhi" class="form-control" type="number" step="100" min="0" id="doanPhi" />
                            <span asp-validation-for="DoanPhi" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="LopHoc" class="form-label">Lớp học</label>
                            <input asp-for="LopHoc" class="form-control" type="number" step="1000" min="0" id="lopHoc" />
                            <span asp-validation-for="LopHoc" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="TrUung" class="form-label">Ứng trước</label>
                            <input asp-for="TrUung" class="form-control" type="number" step="1000" min="0" id="trUung" />
                            <span asp-validation-for="TrUung" class="text-danger"></span>
                        </div>
                    </div>
                </div>



                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Ky" class="form-label">Ký</label>
                            <input asp-for="Ky" class="form-control" maxlength="10" />
                            <span asp-validation-for="Ky" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i>Hủy
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
                         // Format số tiền khi nhập
             $('input[type="number"]').on('input', function() {
                 var value = $(this).val();
                 if (value && !isNaN(value)) {
                     // Chỉ format khi giá trị hợp lệ
                     var numericValue = value.replace(/[^\d]/g, '');
                     if (numericValue) {
                         $(this).val(parseInt(numericValue).toLocaleString('vi-VN'));
                     }
                 }
             });

            // Xử lý khi submit form
            $('form').on('submit', function() {
                // Chuyển đổi định dạng số về dạng số nguyên trước khi submit
                $('input[type="number"]').each(function() {
                    var value = $(this).val();
                    if (value) {
                        var numericValue = value.replace(/[^\d]/g, '');
                        if (numericValue) {
                            $(this).val(numericValue);
                        } else {
                            $(this).val('0');
                        }
                    } else {
                        $(this).val('0');
                    }
                });
            });

            // Khi chọn học viên, load danh mục phụ cấp
            $('#MaHocVien').on('change', function() {
                var maHocVien = $(this).val();
                if (maHocVien) {
                    loadDanhMucPhuCap(maHocVien);
                } else {
                    resetDanhMucPhuCap();
                }
            });

            // Hàm load danh mục phụ cấp của học viên
            function loadDanhMucPhuCap(maHocVien) {
                $.ajax({
                    url: '/HuongPhuCap/GetPhuCapInfo',
                    type: 'GET',
                    data: { maHocVien: maHocVien },
                    success: function(data) {
                        var html = '<div class="row">';
                        html += '<div class="col-md-3"><strong>Tổng phụ cấp:</strong><br><span class="text-primary fw-bold">' + data.tongPhuCap.toLocaleString('vi-VN') + ' VNĐ</span></div>';
                        html += '<div class="col-md-3"><strong>Phụ cấp cơ bản:</strong><br><span class="text-info">' + data.phuCapCoBan.toLocaleString('vi-VN') + ' VNĐ</span></div>';
                        html += '<div class="col-md-3"><strong>Phụ cấp T7+CN:</strong><br><span class="text-warning">' + data.phuCapT7CN.toLocaleString('vi-VN') + ' VNĐ</span></div>';
                        html += '<div class="col-md-3"><strong>Phụ cấp sữa:</strong><br><span class="text-success">' + data.phuCapSua.toLocaleString('vi-VN') + ' VNĐ</span></div>';
                        html += '</div>';
                        $('#danhMucPhuCapList').html(html);
                    },
                    error: function() {
                        $('#danhMucPhuCapList').html('<div class="text-danger text-center">Không thể tải thông tin phụ cấp</div>');
                    }
                });
            }

            // Hàm reset danh mục phụ cấp
            function resetDanhMucPhuCap() {
                $('#danhMucPhuCapList').html('<div class="text-muted text-center">Chọn học viên để xem danh mục phụ cấp</div>');
            }

            
        });
    </script>
}
