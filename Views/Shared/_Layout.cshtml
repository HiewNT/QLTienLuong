<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - QL Tien Luong</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/QLTienLuong.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
</head>
<body class="modern-layout">
    <!-- Top Header -->
    <header class="top-header">
        <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between">
                <!-- Logo & Brand -->
                <div class="brand-section d-flex align-items-center">
                    <button class="sidebar-toggle btn btn-link text-white me-3" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="brand-info">
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-graduation-cap me-1"></i>
                            QL Tiền Lương
                        </h5>
                        <small class="text-white-50">Hệ thống quản lý tiền lương</small>
                    </div>
                </div>



                    <div class="user-section">
                        <div class="dropdown">
                            <button class="btn btn-link text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle fa-lg"></i>
                                </div>
                                <span class="ms-1">@(User.FindFirst("HoTen")?.Value ?? User.Identity.Name)</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" asp-controller="Home" asp-action="Profile"><i class="fas fa-user-edit me-2"></i>Hồ sơ cá nhân</a></li>
                                <li><a class="dropdown-item" asp-controller="Account" asp-action="ChangePassword"><i class="fas fa-key me-2"></i>Đổi mật khẩu</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form asp-controller="Account" asp-action="Logout" method="post" style="display: inline;">
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
            </div>
        </div>
    </header>

    <div class="layout-wrapper">
        <!-- Sidebar -->
        <aside class="modern-sidebar" id="sidebar">
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    @{
                        var userRole = User.FindFirst("MaRole")?.Value;
                        var isAdmin = userRole == "1";
                        var isLopTruong = userRole == "2";
                        var isHocVien = userRole == "3";
                        var isNhanVienTaiChinh = userRole == "4";
                    }

                    <!-- Dashboard - Chỉ Admin và Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Home" && ViewContext.RouteData.Values["Action"]?.ToString() == "Index" ? "active" : "")" 
                           asp-controller="Home" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    }

                    <!-- Hồ sơ cá nhân - Chỉ Học viên và Lớp trưởng -->
                    @if (isHocVien || isLopTruong)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Home" && ViewContext.RouteData.Values["Action"]?.ToString() == "Profile" ? "active" : "")" 
                           asp-controller="Home" asp-action="Profile">
                            <div class="nav-icon">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <span class="nav-text">Hồ sơ cá nhân</span>
                        </a>
                    }

                    <!-- Quản lý chính - Chỉ Admin và Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <div class="nav-section-header">
                            <span>Quản lý chính</span>
                        </div>
                    }

                    <!-- Học viên Quốc tế - Admin, Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "HocVien" ? "active" : "")" 
                           asp-controller="HocVien" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="nav-text">Học viên Quốc tế</span>
                        </a>
                    }

                    <!-- Danh sách học viên lớp - Chỉ Lớp trưởng -->
                    @if (isLopTruong)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "LopTruong" ? "active" : "")" 
                           asp-controller="LopTruong" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <span class="nav-text">Danh sách học viên lớp</span>
                        </a>
                    }

                    <!-- Danh mục Phụ cấp - Chỉ Admin và Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "DanhMucPhuCap" ? "active" : "")" 
                           asp-controller="DanhMucPhuCap" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-money-bill"></i>
                            </div>
                            <span class="nav-text">Danh mục Phụ cấp</span>
                        </a>
                    }

                    <!-- Hưởng Phụ cấp - Chỉ Admin và Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "HuongPhuCap" ? "active" : "")" 
                           asp-controller="HuongPhuCap" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <span class="nav-text">Hưởng Phụ cấp</span>
                        </a>
                    }

                    <!-- Khen thưởng/Kỷ luật - Chỉ Admin và Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "KhenThuongKyLuat" ? "active" : "")" 
                           asp-controller="KhenThuongKyLuat" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-award"></i>
                            </div>
                            <span class="nav-text">Khen thưởng/Kỷ luật</span>
                        </a>
                    }

                    <!-- Tăng cường - Chỉ Admin và Nhân viên tài chính -->
                    @if (isAdmin || isNhanVienTaiChinh)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "TangLuong" ? "active" : "")" 
                           asp-controller="TangLuong" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <span class="nav-text">Tăng cường</span>
                        </a>
                    }

                    <!-- Quốc tịch - Chỉ Admin -->
                    @if (isAdmin)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "QuocTich" ? "active" : "")" 
                           asp-controller="QuocTich" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <span class="nav-text">Quốc tịch</span>
                        </a>
                    }

                    <!-- Người dùng - Chỉ Admin -->
                    @if (isAdmin)
                    {
                        <a class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "User" ? "active" : "")" 
                           asp-controller="User" asp-action="Index">
                            <div class="nav-icon">
                                <i class="fas fa-user-cog"></i>
                            </div>
                            <span class="nav-text">Người dùng</span>
                        </a>
                    }
                </nav>

            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Breadcrumb -->
            <nav class="breadcrumb-section">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-between">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a asp-controller="Home" asp-action="Index">
                                        <i class="fas fa-home me-1"></i>Trang chủ
                                    </a>
                                </li>
                                <li class="breadcrumb-item active">@ViewData["Title"]</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <div class="page-content">
                <div class="container-fluid">
                    @RenderBody()
                </div>
            </div>

            <!-- Footer -->
            <footer class="main-footer">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="footer-info">
                            <span class="text-muted">
                                © 2024 Hệ thống Quản lý Tiền lương. 
                            </span>
                        </div>
                        <div class="footer-stats">
                            <span class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Cập nhật: <span id="currentTime"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    <!-- Layout Scripts -->
    <script>
        $(document).ready(function() {
            // Sidebar toggle functionality
            $('#sidebarToggle').on('click', function() {
                $('body').toggleClass('sidebar-collapsed');
            });

            // Close sidebar on overlay click (mobile)
            $('#sidebarOverlay').on('click', function() {
                $('body').removeClass('sidebar-open');
            });

            // Update current time
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleString('vi-VN');
                $('#currentTime').text(timeString);
            }
            updateTime();
            setInterval(updateTime, 60000); // Update every minute

            // Responsive sidebar
            function handleResize() {
                if ($(window).width() < 768) {
                    $('body').addClass('mobile-view');
                } else {
                    $('body').removeClass('mobile-view sidebar-open');
                }
            }
            
            handleResize();
            $(window).resize(handleResize);

            // Mobile sidebar toggle
            if ($(window).width() < 768) {
                $('#sidebarToggle').on('click', function(e) {
                    e.preventDefault();
                    $('body').toggleClass('sidebar-open');
                });
            }
        });

        // Global function for safe back navigation
        function safeGoBack(defaultUrl) {
            try {
                // Thử quay lại trang trước đó
                if (document.referrer && document.referrer !== window.location.href) {
                    window.history.back();
                } else if (defaultUrl) {
                    // Nếu không có trang trước đó hoặc cùng trang, chuyển về URL mặc định
                    window.location.href = defaultUrl;
                } else {
                    // Fallback: về trang chủ
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Lỗi khi quay lại:', error);
                // Fallback: về trang chủ
                window.location.href = '/';
            }
        }
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
